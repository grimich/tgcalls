<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Jitsi Mini App (FINAL CHROME)</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <script>console.log("DEBUG STEP 1: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ HTML –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤.");</script>

    <style>
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Mini App / Browser */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: var(--tg-theme-bg-color, #f4f4f4); 
            font-family: sans-serif;
        }
        
        #jitsi-container {
            width: 100%;
            height: 100vh; 
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: inherit;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .error-message {
            color: var(--tg-theme-destructive-text-color, red);
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="jitsi-container"></div>
    
    <div class="loading-screen" id="loading-screen">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞...</p>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ.</p>
        <p id="context-info"></p>
    </div>

    <script>
        console.log("DEBUG STEP 2: –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ JavaScript.");
        
        // --- 1. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ì–õ–£–®–ö–ò TELEGRAM SDK (–î–õ–Ø CHROME) ---
        function mockTelegramWebApp() {
            console.warn("DEBUG MOCK: Telegram WebApp SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥–ª—É—à–∫–∏.");
            window.Telegram = {
                WebApp: {
                    ready: (callback) => { 
                        // –í –∑–∞–≥–ª—É—à–∫–µ ready –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–ª–±—ç–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                        if (callback) setTimeout(callback, 0); 
                    },
                    expand: () => console.log('MOCK: Telegram.WebApp.expand() –≤—ã–∑–≤–∞–Ω.'),
                    close: () => {
                        console.log('MOCK: Telegram.WebApp.close(). –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
                        alert('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –í —Ä–µ–∞–ª—å–Ω–æ–º Mini App –æ–∫–Ω–æ –±—ã –∑–∞–∫—Ä—ã–ª–æ—Å—å.');
                        const container = document.getElementById('jitsi-container');
                        if (container) container.innerHTML = '<h2>–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.</h2>';
                    },
                    onEvent: (event, handler) => console.log(`MOCK: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ ${event}`),
                    BackButton: {
                        show: () => console.log('MOCK: BackButton.show()'),
                        hide: () => console.log('MOCK: BackButton.hide()'),
                    },
                    themeParams: {
                        bg_color: '#f4f4f4',
                        text_color: '#000000'
                    },
                    initDataUnsafe: {
                        user: { first_name: "–¢–µ—Å—Ç–æ–≤—ã–π", last_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }
                    }
                }
            };
        }

        // --- 2. –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø –ò –ó–ê–ü–£–°–ö ---
        let isInsideTelegram = typeof Telegram !== 'undefined' && Telegram.WebApp;
        const contextInfo = document.getElementById('context-info');

        if (!isInsideTelegram) {
            // –õ–û–ì–ò–ö–ê –î–õ–Ø CHROME
            mockTelegramWebApp();
            contextInfo.innerHTML = '<span class="error-message">–ó–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Mock SDK.</span>';
            console.log("DEBUG CHROME: –ó–∞–ø—É—Å–∫ Jitsi –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.");
            
            // üí° –ì–ê–†–ê–ù–¢–ò–Ø –ó–ê–ü–£–°–ö–ê –í –ë–†–ê–£–ó–ï–†–ï: –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
            initializeJitsi();
            
        } else {
            // –õ–û–ì–ò–ö–ê –î–õ–Ø TELEGRAM
            contextInfo.innerHTML = '–ó–∞–ø—É—Å–∫ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.';
            
            // üí° –ì–ê–†–ê–ù–¢–ò–Ø –ó–ê–ü–£–°–ö–ê –í TELEGRAM: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ ready (–∏–ª–∏ —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –≥–æ—Ç–æ–≤–æ)
            Telegram.WebApp.ready(() => {
                console.log("DEBUG TELEGRAM: Telegram.WebApp.ready() —Å—Ä–∞–±–æ—Ç–∞–ª. –ó–∞–ø—É—Å–∫ initializeJitsi().");
                Telegram.WebApp.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º Mini App
                initializeJitsi();
            });
            console.log("DEBUG TELEGRAM: –û–∂–∏–¥–∞–Ω–∏–µ Telegram.WebApp.ready().");
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤
        document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color;
        console.log("DEBUG STEP 3: SDK –ø—Ä–æ–≤–µ—Ä–µ–Ω, —Ü–≤–µ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.");


        // --- 3. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID –ö–û–ú–ù–ê–¢–´ ---
        function getRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');

            if (startParam) {
                console.log(`DEBUG STEP 4: –ù–∞–π–¥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä 'start' –≤ URL: ${startParam}`);
                return startParam;
            }
            
            const randomId = Math.random().toString(36).substring(2, 10);
            console.warn(`DEBUG STEP 4: –ü–∞—Ä–∞–º–µ—Ç—Ä 'start' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ ID: ${randomId}`);
            return `TestRoom_${randomId}`;
        }


        // --- 4. –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò JITSI ---
        function initializeJitsi() {
            console.log("DEBUG STEP 5: –ó–∞–ø—É—Å–∫ initializeJitsi().");
            
            const domain = 'meet.jit.si'; 
            let api = null;
            
            const chatIdentifier = getRoomId();
            const roomName = `TelegramMiniApp_Room_${chatIdentifier}`; 
            
            console.log(`DEBUG JITSI: –ò–º—è –∫–æ–º–Ω–∞—Ç—ã: ${roomName}`);
            
            const options = {
                roomName: roomName,
                parentNode: document.querySelector('#jitsi-container'),
                
                onload: () => {
                    console.log("DEBUG JITSI: –°–æ–±—ã—Ç–∏–µ 'onload' —Å—Ä–∞–±–æ—Ç–∞–ª–æ. Jitsi iframe –∑–∞–≥—Ä—É–∂–µ–Ω.");
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) loadingScreen.style.display = 'none';
                },
                
                width: '100%',
                height: '100%',
                
                configOverwrite: {
                    channelLastN: 12, 
                    prejoinPageEnabled: false, 
                    enableWelcomePage: false, 
                },
                
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false,
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'desktop', 'fullscreen',
                        'fodeviceselection', 'hangup', 'chat', 'tileview', 'settings'
                    ],
                    CLOSE_BUTTON_ENABLED: false 
                }
            };
            
            try {
                console.log("DEBUG STEP 6: –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ JitsiMeetExternalAPI.");
                api = new JitsiMeetExternalAPI(domain, options);
                console.log("DEBUG JITSI: –≠–∫–∑–µ–º–ø–ª—è—Ä API —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.");
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                if (isInsideTelegram) {
                    console.log("DEBUG TELEGRAM: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ BackButton.");
                    Telegram.WebApp.onEvent('backButtonClicked', () => {
                        if (api) api.dispose(); 
                        Telegram.WebApp.close();
                    });
                    Telegram.WebApp.BackButton.show();
                }

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–æ–≥–∏–∫–∞ –æ–ø—É—â–µ–Ω–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –ª–æ–≥–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
                if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                    const user = Telegram.WebApp.initDataUnsafe.user;
                    const displayName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    api.executeCommand('displayName', displayName || '–ì–æ—Å—Ç—å Telegram');
                }
                
                api.addEventListener('readyToClose', () => {
                    console.log('DEBUG JITSI EVENT: readyToClose. –ó–∞–∫—Ä—ã—Ç–∏–µ.');
                    Telegram.WebApp.close(); 
                });

            } catch (error) {
                console.error("DEBUG JITSI CRITICAL ERROR:", error);
                document.getElementById('loading-screen').innerHTML = `<p class="error-message">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.</p><p>${error.message}</p>`;
            }
        }
        
        console.log("DEBUG STEP 8: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞.");
    </script>

</body>
</html>
