<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Jitsi Mini App</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://meet.jit.si/external_api.js"></script>
    
    <style>
        /* Стилизация для Mini App / Browser */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            /* Используем CSS переменные Telegram для соответствия теме */
            background-color: var(--tg-theme-bg-color, #f4f4f4); 
            font-family: sans-serif;
        }
        
        #jitsi-container {
            width: 100%;
            height: 100vh; 
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: inherit; /* Использует цвет из body */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .error-message {
            color: var(--tg-theme-destructive-text-color, red);
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="jitsi-container"></div>
    
    <div class="loading-screen" id="loading-screen">
        <p>Загрузка группового звонка...</p>
        <p>Пожалуйста, ожидайте.</p>
        <p id="context-info"></p>
    </div>

    <script>
        // --- 1. ФУНКЦИЯ ДЛЯ ЗАГЛУШКИ TELEGRAM SDK ---
        function mockTelegramWebApp() {
            // Создаем минимальный объект, чтобы избежать ошибок ReferenceError
            window.Telegram = {
                WebApp: {
                    ready: () => console.log('Mock: Telegram.WebApp.ready()'),
                    expand: () => console.log('Mock: Telegram.WebApp.expand()'),
                    close: () => {
                        console.log('Mock: Telegram.WebApp.close(). Завершение в браузере.');
                        alert('Звонок завершен. В реальном Mini App окно бы закрылось.');
                        document.getElementById('jitsi-container').innerHTML = '<h2>Звонок завершен.</h2>';
                    },
                    onEvent: (event, handler) => console.log(`Mock: Subscribed to ${event}`),
                    BackButton: {
                        show: () => console.log('Mock: BackButton.show()'),
                        hide: () => console.log('Mock: BackButton.hide()'),
                    },
                    themeParams: {
                        bg_color: '#f4f4f4',
                        text_color: '#000000'
                    },
                    // Имитируем initDataUnsafe для Chrome
                    initDataUnsafe: {
                        user: { first_name: "Тестовый", last_name: "Пользователь" }
                    }
                }
            };
        }

        // --- 2. ПРОВЕРКА ОКРУЖЕНИЯ И ИНИЦИАЛИЗАЦИЯ ---
        let isInsideTelegram = typeof Telegram !== 'undefined' && Telegram.WebApp;

        if (!isInsideTelegram) {
            mockTelegramWebApp();
            document.getElementById('context-info').innerHTML = '<span class="error-message">Запуск в браузере (Chrome). WebApp SDK отсутствует.</span>';
        } else {
            document.getElementById('context-info').innerHTML = 'Запуск внутри Telegram Mini App.';
        }
        
        // Устанавливаем цвета для соответствия Telegram (работает и с заглушкой)
        document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color;
        
        // --- 3. ФУНКЦИЯ ДЛЯ ИЗВЛЕЧЕНИЯ ПАРАМЕТРОВ ---
        function getRoomId() {
            // Ищем параметр 'start' в URL (для Chrome) или в initData (для Telegram)
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');

            // Если есть startParam (например, '?start=12345'), используем его.
            if (startParam) {
                return startParam;
            }
            
            // Если нет, генерируем случайный ID для тестовых целей.
            const randomId = Math.random().toString(36).substring(2, 10);
            return `TestRoom_${randomId}`;
        }


        // --- 4. ОСНОВНАЯ ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ JITSI ---
        Telegram.WebApp.ready(() => {
            // Расширяем Mini App на весь экран (в Chrome это просто логируется)
            Telegram.WebApp.expand();
            
            initializeJitsi();
        });


        function initializeJitsi() {
            const domain = 'meet.jit.si'; 
            let api = null;
            
            // Уникальное имя комнаты
            const chatIdentifier = getRoomId();
            const roomName = `TelegramMiniApp_Room_${chatIdentifier}`; 
            
            console.log(`Jitsi Room Name: ${roomName}`);
            
            const options = {
                roomName: roomName,
                parentNode: document.querySelector('#jitsi-container'),
                onload: () => {
                    // Скрываем экран загрузки, когда iframe Jitsi загружен
                    document.getElementById('loading-screen').style.display = 'none';
                },
                width: '100%',
                height: '100%',
                
                configOverwrite: {
                    channelLastN: 12, 
                    prejoinPageEnabled: false, 
                },
                
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false,
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'desktop', 'fullscreen',
                        'fodeviceselection', 'hangup', 'chat', 'tileview', 'settings'
                    ],
                    CLOSE_BUTTON_ENABLED: false // Используем кнопку закрытия Telegram
                }
            };
            
            try {
                api = new JitsiMeetExternalAPI(domain, options);
                
                // Обработка завершения звонка
                api.addEventListener('readyToClose', () => {
                    console.log('Jitsi: Звонок завершен. Закрываем Mini App.');
                    Telegram.WebApp.close(); 
                });

                // Установить имя пользователя
                if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                    const user = Telegram.WebApp.initDataUnsafe.user;
                    const displayName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    api.executeCommand('displayName', displayName || 'Гость Telegram');
                }

                // Добавляем обработчик для кнопки "Назад" в Telegram
                if (isInsideTelegram) {
                    Telegram.WebApp.onEvent('backButtonClicked', () => {
                        api.dispose(); // Завершить Jitsi-сессию
                        Telegram.WebApp.close(); 
                    });
                    Telegram.WebApp.BackButton.show();
                }

            } catch (error) {
                console.error("Ошибка при инициализации Jitsi:", error);
                document.getElementById('loading-screen').innerHTML = `
                    <p class="error-message">Не удалось загрузить видеозвонок.</p>
                    <p>Проверьте консоль браузера для деталей.</p>`;
            }
        }
    </script>

</body>
</html>
