<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Jitsi Mini App | V5 (URL Name)</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ SDK Jitsi –∏ Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <script>
        const APP_VERSION = 'V5 (URL Name)';
        console.log(`DEBUG STEP 1: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ HTML –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤. –í–µ—Ä—Å–∏—è: ${APP_VERSION}`);
    </script>

    <style>
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Mini App / Browser */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: var(--tg-theme-bg-color, #f4f4f4); 
            font-family: sans-serif;
        }
        
        #jitsi-container {
            width: 100%;
            height: 100vh; 
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: inherit;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .error-message {
            color: var(--tg-theme-destructive-text-color, red);
            margin-top: 10px;
        }
        .version-info {
            margin-top: 10px;
            font-size: 0.8em;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="jitsi-container"></div>
    
    <div class="loading-screen" id="loading-screen">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞...</p>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ.</p>
        <p id="context-info"></p>
        <p class="version-info">–í–µ—Ä—Å–∏—è: <span id="app-version"></span></p>
    </div>

    <script>
        document.getElementById('app-version').textContent = APP_VERSION;
        console.log("DEBUG STEP 2: –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ JavaScript.");
        
        // --- 1. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ì–õ–£–®–ö–ò TELEGRAM SDK (–î–õ–Ø CHROME) ---
        function mockTelegramWebApp() {
            console.warn("DEBUG MOCK: Telegram WebApp SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥–ª—É—à–∫–∏.");
            window.Telegram = {
                WebApp: {
                    ready: (callback) => { if (callback) setTimeout(callback, 0); },
                    expand: () => console.log('MOCK: Telegram.WebApp.expand() –≤—ã–∑–≤–∞–Ω.'),
                    close: () => {
                        console.log('MOCK: Telegram.WebApp.close(). –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
                        alert('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –í —Ä–µ–∞–ª—å–Ω–æ–º Mini App –æ–∫–Ω–æ –±—ã –∑–∞–∫—Ä—ã–ª–æ—Å—å.');
                        const container = document.getElementById('jitsi-container');
                        if (container) container.innerHTML = '<h2>–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.</h2>';
                    },
                    onEvent: (event, handler) => console.log(`MOCK: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ ${event}`),
                    BackButton: {
                        show: () => console.log('MOCK: BackButton.show()'),
                        hide: () => console.log('MOCK: BackButton.hide()'),
                    },
                    themeParams: {
                        bg_color: '#f4f4f4',
                        text_color: '#000000'
                    },
                    initDataUnsafe: {
                        // –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã fallback –ª–æ–≥–∏–∫–∏
                        user: { first_name: "–¢–µ—Å—Ç–æ–≤—ã–π", last_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" } 
                    }
                }
            };
        }

        // --- 2. –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø –ò –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô –ó–ê–ü–£–°–ö ---
        let isInsideTelegram = typeof Telegram !== 'undefined' && Telegram.WebApp;
        const contextInfo = document.getElementById('context-info');

        if (!isInsideTelegram) {
            // –õ–û–ì–ò–ö–ê –î–õ–Ø CHROME (–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫)
            mockTelegramWebApp();
            contextInfo.innerHTML = `<span class="error-message">–ó–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Mock SDK.</span> (${APP_VERSION})`;
            console.log("DEBUG CHROME: –ó–∞–ø—É—Å–∫ Jitsi –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.");
            initializeJitsi();
            
        } else {
            // –õ–û–ì–ò–ö–ê –î–õ–Ø TELEGRAM (–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫)
            contextInfo.innerHTML = `–ó–∞–ø—É—Å–∫ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App. (${APP_VERSION})`;
            console.log("DEBUG TELEGRAM: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ Jitsi (–æ–±—Ö–æ–¥ race condition).");
            
            // –†–∞—Å—à–∏—Ä—è–µ–º Mini App
            Telegram.WebApp.expand();
            
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –í–´–ó–û–í: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ Jitsi –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Å—Ä–∞–∑—É.
            initializeJitsi(); 

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º onReady –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            Telegram.WebApp.ready(() => {
                console.log("DEBUG TELEGRAM: –°—Ä–∞–±–æ—Ç–∞–ª–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ ready.");
            });
            
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤
        document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color;
        console.log("DEBUG STEP 3: SDK –ø—Ä–æ–≤–µ—Ä–µ–Ω, —Ü–≤–µ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.");


        // --- 3. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID –ö–û–ú–ù–ê–¢–´ ---
        function getRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            // –ü–∞—Ä–∞–º–µ—Ç—Ä start –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è ID –∫–æ–º–Ω–∞—Ç—ã/—á–∞—Ç–∞
            const startParam = urlParams.get('start'); 

            if (startParam) {
                console.log(`DEBUG STEP 4: –ù–∞–π–¥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä 'start' –≤ URL: ${startParam}`);
                return startParam;
            }
            
            const randomId = Math.random().toString(36).substring(2, 10);
            console.warn(`DEBUG STEP 4: –ü–∞—Ä–∞–º–µ—Ç—Ä 'start' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ ID: ${randomId}`);
            return `TestRoom_${randomId}`;
        }
        
        // --- 4. –ù–û–í–ê–Ø: –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø –ò–ú–ï–ù–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ò–ó URL ---
        function getDisplayName() {
            const urlParams = new URLSearchParams(window.location.search);
            // –ò–º—è –¥–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ 'display_name'
            const nameParam = urlParams.get('display_name');

            if (nameParam) {
                const decodedName = decodeURIComponent(nameParam);
                console.log(`DEBUG STEP 4.1: –ù–∞–π–¥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä 'display_name' –≤ URL: ${decodedName}`);
                return decodedName;
            }
            
            // FALLBACK 1: –ü–æ–ø—ã—Ç–∫–∞ –≤–∑—è—Ç—å –∏–º—è –∏–∑ Telegram SDK
            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                const telegramName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                if (telegramName) {
                    console.warn("DEBUG STEP 4.1: –ü–∞—Ä–∞–º–µ—Ç—Ä 'display_name' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∏–∑ Telegram SDK.");
                    return telegramName;
                }
            }
            
            // FALLBACK 2: –ò–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            console.warn("DEBUG STEP 4.1: –ü–∞—Ä–∞–º–µ—Ç—Ä 'display_name' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.");
            return '–ì–æ—Å—Ç—å Mini App';
        }


        // --- 5. –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò JITSI ---
        function initializeJitsi() {
            console.log("DEBUG STEP 5: –ó–∞–ø—É—Å–∫ initializeJitsi().");
            
            const domain = 'meet.jit.si'; 
            let api = null;
            
            const chatIdentifier = getRoomId();
            const roomName = `TelegramMiniApp_Room_${chatIdentifier}`; 
            
            console.log(`DEBUG JITSI: –ò–º—è –∫–æ–º–Ω–∞—Ç—ã: ${roomName}`);
            
            const options = {
                roomName: roomName,
                parentNode: document.querySelector('#jitsi-container'),
                
                onload: () => {
                    console.log("DEBUG JITSI: –°–æ–±—ã—Ç–∏–µ 'onload' —Å—Ä–∞–±–æ—Ç–∞–ª–æ. Jitsi iframe –∑–∞–≥—Ä—É–∂–µ–Ω.");
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) loadingScreen.style.display = 'none';
                },
                
                width: '100%',
                height: '100%',
                
                configOverwrite: {
                    channelLastN: 12, 
                    prejoinPageEnabled: false, 
                    enableWelcomePage: false, 
                },
                
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false,
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'desktop', 'fullscreen',
                        'fodeviceselection', 'hangup', 'chat', 'tileview', 'settings'
                    ],
                    CLOSE_BUTTON_ENABLED: false 
                }
            };
            
            try {
                console.log("DEBUG STEP 6: –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ JitsiMeetExternalAPI.");
                api = new JitsiMeetExternalAPI(domain, options);
                console.log("DEBUG JITSI: –≠–∫–∑–µ–º–ø–ª—è—Ä API —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.");
                
                // üí° –£–°–¢–ê–ù–û–í–ö–ê –ò–ú–ï–ù–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ò–ó URL (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)
                const displayName = getDisplayName();
                if (api && displayName) {
                    api.executeCommand('displayName', displayName);
                    console.log(`DEBUG JITSI: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è: ${displayName}`);
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" (—Ç–æ–ª—å–∫–æ –¥–ª—è Telegram)
                if (isInsideTelegram) {
                    Telegram.WebApp.onEvent('backButtonClicked', () => {
                        if (api) api.dispose(); 
                        Telegram.WebApp.close();
                    });
                    Telegram.WebApp.BackButton.show();
                }
                
                api.addEventListener('readyToClose', () => {
                    console.log('DEBUG JITSI EVENT: readyToClose. –ó–∞–∫—Ä—ã—Ç–∏–µ.');
                    Telegram.WebApp.close(); 
                });

            } catch (error) {
                console.error("DEBUG JITSI CRITICAL ERROR:", error);
                document.getElementById('loading-screen').innerHTML = `<p class="error-message">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.</p><p>${error.message}</p>`;
            }
        }
        
        console.log("DEBUG STEP 8: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞.");
    </script>

</body>
</html>


### –ö–∞–∫ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å URL –¥–ª—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞:

–ö–æ–≥–¥–∞ –≤–∞—à –±–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ Mini App, –æ–Ω –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:

1.  `start`: ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, ID —á–∞—Ç–∞).
2.  `display_name`: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ URL (`url-encoded`).

**–ü—Ä–∏–º–µ—Ä URL:**
