<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Jitsi Mini App | V4</title>
    
    <!-- Подключение SDK Jitsi и Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <script>
        const APP_VERSION = 'V4 (Guaranteed Launch)';
        console.log(`DEBUG STEP 1: Начало загрузки HTML и скриптов. Версия: ${APP_VERSION}`);
    </script>

    <style>
        /* Стилизация для Mini App / Browser */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: var(--tg-theme-bg-color, #f4f4f4); 
            font-family: sans-serif;
        }
        
        #jitsi-container {
            width: 100%;
            height: 100vh; 
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: inherit;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .error-message {
            color: var(--tg-theme-destructive-text-color, red);
            margin-top: 10px;
        }
        .version-info {
            margin-top: 10px;
            font-size: 0.8em;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="jitsi-container"></div>
    
    <div class="loading-screen" id="loading-screen">
        <p>Загрузка группового звонка...</p>
        <p>Пожалуйста, ожидайте.</p>
        <p id="context-info"></p>
        <p class="version-info">Версия: <span id="app-version"></span></p>
    </div>

    <script>
        document.getElementById('app-version').textContent = APP_VERSION;
        console.log("DEBUG STEP 2: Запуск основного JavaScript.");
        
        // --- 1. ФУНКЦИЯ ДЛЯ ЗАГЛУШКИ TELEGRAM SDK (ДЛЯ CHROME) ---
        function mockTelegramWebApp() {
            console.warn("DEBUG MOCK: Telegram WebApp SDK не найден. Инициализация заглушки.");
            window.Telegram = {
                WebApp: {
                    ready: (callback) => { if (callback) setTimeout(callback, 0); },
                    expand: () => console.log('MOCK: Telegram.WebApp.expand() вызван.'),
                    close: () => {
                        console.log('MOCK: Telegram.WebApp.close(). Завершение в браузере.');
                        alert('Звонок завершен. В реальном Mini App окно бы закрылось.');
                        const container = document.getElementById('jitsi-container');
                        if (container) container.innerHTML = '<h2>Звонок завершен.</h2>';
                    },
                    onEvent: (event, handler) => console.log(`MOCK: Подписка на событие ${event}`),
                    BackButton: {
                        show: () => console.log('MOCK: BackButton.show()'),
                        hide: () => console.log('MOCK: BackButton.hide()'),
                    },
                    themeParams: {
                        bg_color: '#f4f4f4',
                        text_color: '#000000'
                    },
                    initDataUnsafe: {
                        user: { first_name: "Тестовый", last_name: "Пользователь" }
                    }
                }
            };
        }

        // --- 2. ПРОВЕРКА ОКРУЖЕНИЯ И ГАРАНТИРОВАННЫЙ ЗАПУСК ---
        let isInsideTelegram = typeof Telegram !== 'undefined' && Telegram.WebApp;
        const contextInfo = document.getElementById('context-info');

        if (!isInsideTelegram) {
            // ЛОГИКА ДЛЯ CHROME (Принудительный запуск)
            mockTelegramWebApp();
            contextInfo.innerHTML = `<span class="error-message">Запуск в браузере. Используется Mock SDK.</span> (V4)`;
            console.log("DEBUG CHROME (V4): Запуск Jitsi немедленно.");
            initializeJitsi();
            
        } else {
            // ЛОГИКА ДЛЯ TELEGRAM (Принудительный запуск)
            contextInfo.innerHTML = `Запуск внутри Telegram Mini App. (V4)`;
            console.log("DEBUG TELEGRAM (V4): Прямой запуск Jitsi (обход race condition).");
            
            // Расширяем Mini App сразу же
            Telegram.WebApp.expand();
            
            // ПРИНУДИТЕЛЬНЫЙ ВЫЗОВ: Гарантируем, что Jitsi запустится, 
            // не дожидаясь события ready, которое пропускается.
            initializeJitsi(); 

            // Дополнительно регистрируем onReady для обратной совместимости, но не для запуска
            Telegram.WebApp.ready(() => {
                console.log("DEBUG TELEGRAM (V4): Сработало резервное событие ready.");
            });
            
        }
        
        // Установка цветов
        document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color;
        console.log("DEBUG STEP 3: SDK проверен, цвета установлены.");


        // --- 3. ФУНКЦИЯ ДЛЯ ИЗВЛЕЧЕНИЯ ID КОМНАТЫ ---
        function getRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');

            if (startParam) {
                console.log(`DEBUG STEP 4: Найден параметр 'start' в URL: ${startParam}`);
                return startParam;
            }
            
            const randomId = Math.random().toString(36).substring(2, 10);
            console.warn(`DEBUG STEP 4: Параметр 'start' не найден. Использование случайного ID: ${randomId}`);
            return `TestRoom_${randomId}`;
        }


        // --- 4. ОСНОВНАЯ ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ JITSI ---
        function initializeJitsi() {
            console.log("DEBUG STEP 5: Запуск initializeJitsi().");
            
            const domain = 'meet.jit.si'; 
            let api = null;
            
            const chatIdentifier = getRoomId();
            const roomName = `TelegramMiniApp_Room_${chatIdentifier}`; 
            
            console.log(`DEBUG JITSI: Имя комнаты: ${roomName}`);
            
            const options = {
                roomName: roomName,
                parentNode: document.querySelector('#jitsi-container'),
                
                onload: () => {
                    console.log("DEBUG JITSI: Событие 'onload' сработало. Jitsi iframe загружен.");
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) loadingScreen.style.display = 'none';
                },
                
                width: '100%',
                height: '100%',
                
                configOverwrite: {
                    channelLastN: 12, 
                    prejoinPageEnabled: false, 
                    enableWelcomePage: false, 
                },
                
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK: false,
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'desktop', 'fullscreen',
                        'fodeviceselection', 'hangup', 'chat', 'tileview', 'settings'
                    ],
                    CLOSE_BUTTON_ENABLED: false 
                }
            };
            
            try {
                console.log("DEBUG STEP 6: Создание экземпляра JitsiMeetExternalAPI.");
                api = new JitsiMeetExternalAPI(domain, options);
                console.log("DEBUG JITSI: Экземпляр API успешно создан.");
                
                // Настройка кнопки "Назад" (только для Telegram)
                if (isInsideTelegram) {
                    console.log("DEBUG TELEGRAM: Настройка кнопки BackButton.");
                    Telegram.WebApp.onEvent('backButtonClicked', () => {
                        if (api) api.dispose(); 
                        Telegram.WebApp.close();
                    });
                    Telegram.WebApp.BackButton.show();
                }

                if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                    const user = Telegram.WebApp.initDataUnsafe.user;
                    const displayName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    api.executeCommand('displayName', displayName || 'Гость Telegram');
                }
                
                api.addEventListener('readyToClose', () => {
                    console.log('DEBUG JITSI EVENT: readyToClose. Закрытие.');
                    Telegram.WebApp.close(); 
                });

            } catch (error) {
                console.error("DEBUG JITSI CRITICAL ERROR:", error);
                document.getElementById('loading-screen').innerHTML = `<p class="error-message">КРИТИЧЕСКАЯ ОШИБКА: Видеозвонок не загрузился.</p><p>${error.message}</p>`;
            }
        }
        
        console.log("DEBUG STEP 8: Завершение регистрации кода.");
    </script>

</body>
</html>


### Что теперь должно произойти

После обновления файла и **обязательной очистки кэша** в Telegram, ваш лог должен измениться следующим образом:

1.  ... (обычные сообщения Telegram SDK)
2.  `DEBUG STEP 1: Начало загрузки HTML и скриптов. Версия: V4 (Guaranteed Launch)`
3.  `DEBUG STEP 2: Запуск основного JavaScript.`
4.  `DEBUG TELEGRAM (V4): Прямой запуск Jitsi (обход race condition).` $\leftarrow$ **НОВОЕ СООБЩЕНИЕ!**
5.  `DEBUG STEP 5: Запуск initializeJitsi().`
6.  `DEBUG STEP 6: Создание экземпляра JitsiMeetExternalAPI.`
7.  `DEBUG JITSI: Экземпляр API успешно создан.`
8.  `DEBUG JITSI: Событие 'onload' сработало. Jitsi iframe загружен.` $\leftarrow$ **Интерфейс Jitsi должен появиться!**

Сообщите мне, пожалуйста, какой лог вы увидите с версией **V4**. Если Jitsi загрузится, это будет победа над клиентским кэшем!
